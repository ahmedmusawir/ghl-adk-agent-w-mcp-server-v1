FROM python:3.12-slim

# 1. Install System Dependencies (Node.js + Supervisor + Nginx + ApacheUtils)
RUN apt-get update && \
    apt-get install -y curl gnupg nginx apache2-utils && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs supervisor && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 2. Install Python Dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 3. Install Node Dependencies
COPY ghl-mcp-server-moose-v1/package*.json ./ghl-mcp-server-moose-v1/
WORKDIR /app/ghl-mcp-server-moose-v1
RUN npm install

# 4. Copy Application Code
WORKDIR /app
COPY . .

# 5. Build MCP
WORKDIR /app/ghl-mcp-server-moose-v1
RUN npm run build

# 6. CONFIGURATION
WORKDIR /app

# A. Setup Nginx (The Bouncer)
COPY nginx.conf /etc/nginx/nginx.conf
# Create the password file (User: admin, Pass: stark)
# You can change 'stark' to whatever password you want here
RUN htpasswd -bc /etc/nginx/.htpasswd admin stark

# B. Setup Supervisor
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# D. Port Config
# Nginx listens on 8080, so we expose that
ENV PORT=8080
EXPOSE 8080

# 7. Start Supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]